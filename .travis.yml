language: bash

env:
  global:
  - PATH="${HOME}/bin:${PATH}"
  - UI_REPO="dtf-street-works-ux"

services:
  - docker

before_script:
  - echo ${GOOGLE_CREDENTIALS} | base64 --decode > ${HOME}/cicd.json
  - gcloud --quiet version
  - mkdir -p ${HOME}/bin
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  - chmod +x kubectl
  - mv kubectl ${HOME}/bin
  - gcloud config set project $(grep project_id ${HOME}/cicd.json |cut -d\" -f4)
  - gcloud config set compute/zone europe-west2-a
  - gcloud auth activate-service-account --key-file=${HOME}/cicd.json

script:
  - docker build -t ${DOCKER_REPO_HOSTNAME}/$(grep project_id ${HOME}/cicd.json |cut -d\" -f4)/${UI_REPO}:$TRAVIS_COMMIT .
  - ./release.sh ${DOCKER_REPO_HOSTNAME} ${UI_REPO} $TRAVIS_COMMIT

deploy:
  - provider: script
    script: "./deploy.sh streetworks-dev-cluster ${DOCKER_REPO_HOSTNAME} ${UI_REPO} $TRAVIS_COMMIT"
    on:
      branch: master
